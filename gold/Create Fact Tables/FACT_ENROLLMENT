--Create the Enrollment Fact Table

CREATE OR REPLACE TABLE DITTEAU_DATA.GOLD.FACT_ENROLLMENT (
    ENROLLMENT_KEY INT AUTOINCREMENT PRIMARY KEY,
    ENROLLMENT_SOURCE_SERIAL INT,
    ENROLLMENT_STU_KEY INT,
    ENROLLMENT_COURSE_SECTION_KEY INT,
    ENROLLMENT_TERM_KEY INT,
    ENROLLMENT_FACULTY_KEY INT,
    ENROLLMENT_GRADE_KEY INT,
    ENROLLMENT_HOURS FLOAT,
    ENROLLMENT_STATUS VARCHAR, -- add, drop, withdraw
    ENROLLMENT_PROGRAM_LEVEL VARCHAR,
    ENROLLMENT_FIRST_STAT VARCHAR,
    ENROLLMENT_FIRST_DATE_KEY INT,
    ENROLLMENT_LATEST_STAT VARCHAR,
    ENROLLMENT_LATEST_DATE_KEY INT,
    SOURCE_ACTIVE_DATE DATE,
    SOURCE_INACTIVE_DATE DATE,
    IS_CURRENT STRING,
    CREATION_TIMESTAMP TIMESTAMP_LTZ,
    FOREIGN KEY (ENROLLMENT_STU_KEY) REFERENCES DIM_STUDENT(STUDENT_KEY),
    FOREIGN KEY (ENROLLMENT_COURSE_SECTION_KEY) REFERENCES DIM_COURSE_SECTION(COURSE_SECTION_KEY),
    FOREIGN KEY (ENROLLMENT_TERM_KEY) REFERENCES DIM_TERM(TERM_KEY),
    FOREIGN KEY (ENROLLMENT_FACULTY_KEY) REFERENCES DIM_FACULTY(FACULTY_KEY),
    FOREIGN KEY (ENROLLMENT_GRADE_KEY) REFERENCES DIM_GRADE(GRADE_KEY),
    FOREIGN KEY (ENROLLMENT_DATE_KEY) REFERENCES DIM_DATE(DATE_KEY)
    
);

INSERT INTO DITTEAU_DATA.GOLD.FACT_ENROLLMENT (
    ENROLLMENT_SOURCE_SERIAL,
    ENROLLMENT_STU_KEY,
    ENROLLMENT_COURSE_SECTION_KEY,
    ENROLLMENT_TERM_KEY,
    ENROLLMENT_FACULTY_KEY,
    ENROLLMENT_GRADE_KEY,
    ENROLLMENT_HOURS,
    ENROLLMENT_STATUS,
    ENROLLMENT_PROGRAM_LEVEL,
    ENROLLMENT_FIRST_STAT,
    ENROLLMENT_FIRST_DATE_KEY,
    ENROLLMENT_LATEST_STAT,
    ENROLLMENT_LATEST_DATE_KEY,
    SOURCE_ACTIVE_DATE,
    SOURCE_INACTIVE_DATE,
    IS_CURRENT,
    CREATION_TIMESTAMP
)
SELECT
    a.cw_no,
    b.student_key,
    c.course_section_key,
    e.term_key,
    c.course_section_faculty_key,
    g.grade_key,
    a.hrs,
    a.stat,
    a.prog,
    a.first_event_type,
    h.date_key,
    a.latest_event_type_final,
    i.date_key,
    a.beg_date,
    a.end_date,
    'Y',
    CURRENT_TIMESTAMP()
FROM SILVER_CX_CW_REC_ENRICHED a
INNER JOIN DITTEAU_DATA.GOLD.DIM_STUDENT b
    ON a.id = b.student_code
    AND a.prog = b.student_program_level
INNER JOIN DITTEAU_DATA.GOLD.DIM_COURSE_SECTION c
    ON a.crs_no = c.course_section_course_number
    AND a.sec = c.course_section_section_number
    AND a.cat = c.course_section_catalog
    AND a.prog = c.course_section_program_level
    AND a.subsess = c.course_section_subsess
LEFT JOIN DITTEAU_DATA.GOLD.DIM_TERM e
    ON a.sess = e.term_sess
    AND a.yr = e.term_year
    AND a.prog = e.term_program_level
    AND a.subsess = e.term_subsess
LEFT JOIN DITTEAU_DATA.GOLD.DIM_GRADE g
    ON a.grd = g.grade_code
    AND a.grdg = g.grade_category
LEFT JOIN DITTEAU_DATA.GOLD.DIM_DATE h
  ON a.first_event_timestamp = h.date_actual
LEFT JOIN DITTEAU_DATA.GOLD.DIM_DATE i
  ON a.latest_event_timestamp = i.date_actual
;
